<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - Chace Claborn</title>

    <!-- Stylesheets -->
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/auth-styles.css" />
    <link rel="stylesheet" href="../css/tier-styles.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <style>
      .admin-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 40px 20px;
      }

      .admin-header {
        text-align: center;
        margin-bottom: 50px;
        padding: 40px;
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        color: white;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .admin-header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .admin-header p {
        color: #ccc;
        font-size: 1.1rem;
      }

      .admin-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 30px;
        margin-bottom: 40px;
      }

      .admin-card {
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        transition: transform 0.3s, box-shadow 0.3s;
      }

      .admin-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      }

      .admin-card h2 {
        color: #333;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .admin-card h2 i {
        color: #c62828;
      }

      /* Stats Cards */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
        padding: 25px;
        border-radius: 12px;
        text-align: center;
        transition: transform 0.3s;
      }

      .stat-card:hover {
        transform: scale(1.05);
      }

      .stat-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: #617140;
        margin: 10px 0;
      }

      .stat-label {
        color: #666;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      /* User Management */
      .user-list {
        max-height: 500px;
        overflow-y: auto;
      }

      .user-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 15px;
        margin-bottom: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        transition: background 0.3s;
      }

      .user-item:hover {
        background: #e9ecef;
      }

      .user-info-admin {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .user-avatar-small {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
      }

      .user-details {
        flex: 1;
      }

      .user-email {
        font-weight: 500;
        color: #333;
      }

      .user-meta {
        font-size: 0.85rem;
        color: #666;
      }

      .tier-selector {
        padding: 8px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        background: white;
        cursor: pointer;
        transition: all 0.3s;
      }

      .tier-selector:focus {
        outline: none;
        border-color: #617140;
        box-shadow: 0 0 0 3px rgba(97, 113, 64, 0.1);
      }

      /* Tier-specific selector colors */
      .tier-selector.tier-authenticated {
        background: #e3f2fd;
        color: #1976d2;
        border-color: #1976d2;
      }

      .tier-selector.tier-family {
        background: #f3e5f5;
        color: #7b1fa2;
        border-color: #7b1fa2;
      }

      .tier-selector.tier-girlfriend {
        background: #fce4ec;
        color: #d63384;
        border-color: #d63384;
      }

      .tier-selector.tier-admin {
        background: #ffebee;
        color: #c62828;
        border-color: #c62828;
      }

      /* Feedback Section */
      .feedback-item {
        background: #f8f9fa;
        padding: 20px;
        margin-bottom: 15px;
        border-radius: 10px;
        border-left: 4px solid #617140;
      }

      .feedback-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        color: #666;
        font-size: 0.9rem;
      }

      .feedback-text {
        color: #333;
        line-height: 1.6;
        white-space: pre-wrap;
      }

      /* Access Logs */
      .log-item {
        display: flex;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #e0e0e0;
        font-size: 0.9rem;
      }

      .log-status {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-right: 10px;
      }

      .log-allowed {
        background: #4caf50;
      }

      .log-denied {
        background: #f44336;
      }

      .log-details {
        flex: 1;
        color: #666;
      }

      /* Action Buttons */
      .admin-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        flex-wrap: wrap;
      }

      .btn-admin {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
      }

      .btn-refresh {
        background: #4caf50;
        color: white;
      }

      .btn-refresh:hover {
        background: #45a049;
      }

      .btn-export {
        background: #2196f3;
        color: white;
      }

      .btn-export:hover {
        background: #1976d2;
      }

      .btn-clear {
        background: #f44336;
        color: white;
      }

      .btn-clear:hover {
        background: #d32f2f;
      }

      .btn-test {
        background: #ff9800;
        color: white;
      }

      .btn-test:hover {
        background: #f57c00;
      }

      /* Loading States */
      .loading {
        text-align: center;
        padding: 100px 20px;
        font-size: 1.2rem;
        color: #666;
      }

      .loading-spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #617140;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Responsive */
      @media (max-width: 768px) {
        .admin-grid {
          grid-template-columns: 1fr;
        }

        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .admin-header h1 {
          font-size: 2rem;
        }
      }

      /* Security test results */
      .security-results {
        margin-top: 20px;
        padding: 20px;
        background: #f5f5f5;
        border-radius: 8px;
        font-family: monospace;
        font-size: 0.9rem;
        line-height: 1.6;
      }

      .security-pass {
        color: #4caf50;
      }

      .security-fail {
        color: #f44336;
        font-weight: bold;
      }

      /* Full-width cards */
      .full-width {
        grid-column: 1 / -1;
      }
    </style>
  </head>
  <body>
    <div class="content-page">
      <!-- Header -->
      <header class="site-header">
        <div class="header-container">
          <div class="logo">
            <span class="logo-text">chaceclaborn.com</span>
          </div>

          <div class="nav-wrapper">
            <nav class="main-nav">
              <a href="../index.html" class="nav-link">Home</a>
              <a href="portfolio.html" class="nav-link">Portfolio</a>
              <a href="resume.html" class="nav-link">Resume</a>

              <!-- Tier Navigation -->
              <a href="dashboard.html" class="nav-link tier-nav auth-nav"
                >Dashboard</a
              >
              <a href="family.html" class="nav-link tier-nav family-nav"
                >Family</a
              >
              <a href="girlfriend.html" class="nav-link tier-nav girlfriend-nav"
                >Special</a
              >
              <a href="admin.html" class="nav-link tier-nav admin-nav active"
                >Admin</a
              >
            </nav>

            <!-- User Info -->
            <div class="user-info" id="user-info" style="display: none">
              <img
                class="user-avatar"
                id="user-photo"
                src=""
                alt="User Avatar"
              />
              <span class="user-name" id="user-name"></span>
              <span class="user-tier-indicator tier-admin">Admin</span>
              <a href="#" id="logout-btn" class="logout-link">
                <i class="fas fa-sign-out-alt"></i>
              </a>
            </div>
          </div>

          <!-- Mobile Menu Button -->
          <button class="mobile-menu-btn" id="mobile-menu-btn">
            <i class="fas fa-bars"></i>
          </button>
        </div>
      </header>

      <!-- Main Content -->
      <main class="admin-container">
        <div id="loading" class="loading">
          <div class="loading-spinner"></div>
          <p>Verifying admin access...</p>
        </div>

        <div id="admin-content" style="display: none">
          <!-- Admin Header -->
          <div class="admin-header">
            <h1><i class="fas fa-shield-alt"></i> Admin Dashboard</h1>
            <p>Complete control over users, content, and feedback</p>
          </div>

          <!-- Statistics Overview -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Total Users</div>
              <div class="stat-value" id="totalUsers">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Average Rating</div>
              <div class="stat-value" id="avgRating">0.0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Total Ratings</div>
              <div class="stat-value" id="totalRatings">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Feedback Messages</div>
              <div class="stat-value" id="totalFeedback">0</div>
            </div>
          </div>

          <!-- Admin Grid -->
          <div class="admin-grid">
            <!-- User Management -->
            <div class="admin-card">
              <h2><i class="fas fa-users"></i> User Management</h2>
              <div class="user-list" id="userList">
                <p style="text-align: center; color: #666">Loading users...</p>
              </div>
              <div class="admin-actions">
                <button class="btn-admin btn-refresh" onclick="loadUsers()">
                  <i class="fas fa-sync"></i> Refresh
                </button>
              </div>
            </div>

            <!-- Tier Statistics -->
            <div class="admin-card">
              <h2><i class="fas fa-chart-pie"></i> Tier Distribution</h2>
              <div id="tierStats">
                <p style="text-align: center; color: #666">
                  Loading statistics...
                </p>
              </div>
            </div>

            <!-- Feedback Viewer -->
            <div class="admin-card full-width">
              <h2><i class="fas fa-comments"></i> User Feedback</h2>
              <div id="feedbackList">
                <p style="text-align: center; color: #666">
                  Loading feedback...
                </p>
              </div>
              <div class="admin-actions">
                <button class="btn-admin btn-refresh" onclick="loadFeedback()">
                  <i class="fas fa-sync"></i> Refresh
                </button>
                <button class="btn-admin btn-export" onclick="exportFeedback()">
                  <i class="fas fa-download"></i> Export CSV
                </button>
              </div>
            </div>

            <!-- Access Logs -->
            <div class="admin-card full-width">
              <h2><i class="fas fa-history"></i> Recent Access Attempts</h2>
              <div id="accessLogs" style="max-height: 400px; overflow-y: auto">
                <p style="text-align: center; color: #666">
                  Loading access logs...
                </p>
              </div>
              <div class="admin-actions">
                <button
                  class="btn-admin btn-refresh"
                  onclick="loadAccessLogs()"
                >
                  <i class="fas fa-sync"></i> Refresh
                </button>
                <button class="btn-admin btn-clear" onclick="clearOldLogs()">
                  <i class="fas fa-trash"></i> Clear Old Logs
                </button>
              </div>
            </div>

            <!-- Security Test -->
            <div class="admin-card">
              <h2><i class="fas fa-shield-virus"></i> Security Testing</h2>
              <p>
                Run comprehensive security tests to check for vulnerabilities
              </p>
              <div class="admin-actions">
                <button class="btn-admin btn-test" onclick="runSecurityTest()">
                  <i class="fas fa-bug"></i> Run Security Test
                </button>
              </div>
              <div
                id="securityResults"
                class="security-results"
                style="display: none"
              ></div>
            </div>

            <!-- Rating Stats Update -->
            <div class="admin-card">
              <h2><i class="fas fa-calculator"></i> Update Rating Stats</h2>
              <p>
                Manually recalculate rating statistics if they seem incorrect
              </p>
              <div class="admin-actions">
                <button
                  class="btn-admin btn-refresh"
                  onclick="updateRatingStats()"
                >
                  <i class="fas fa-calculator"></i> Update Stats
                </button>
              </div>
              <div id="statsUpdateResult" style="margin-top: 20px"></div>
            </div>
          </div>
        </div>
      </main>

      <!-- Footer -->
      <footer class="site-footer">
        <div class="footer-content">
          <p>&copy; 2025 Chace Claborn. Admin Access Only.</p>
        </div>
      </footer>
    </div>

    <!-- Admin Scripts -->
    <script type="module">
      import { auth, db } from "../js/firebase/config.js";
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
      import {
        collection,
        getDocs,
        doc,
        updateDoc,
        setDoc,
        query,
        orderBy,
        limit,
        where,
        deleteDoc,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
      import {
        protectPage,
        TIERS,
        getAllUsers,
        getTierStats,
        setUserTier,
      } from "../js/firebase/auth-tiers.js";

      // Global functions for button onclick
      window.loadUsers = loadUsers;
      window.loadFeedback = loadFeedback;
      window.loadAccessLogs = loadAccessLogs;
      window.updateRatingStats = updateRatingStats;
      window.exportFeedback = exportFeedback;
      window.clearOldLogs = clearOldLogs;
      window.runSecurityTest = runSecurityTest;
      window.updateUserTier = updateUserTier;

      // Initialize admin dashboard
      onAuthStateChanged(auth, async (user) => {
        const loading = document.getElementById("loading");
        const content = document.getElementById("admin-content");

        if (user) {
          const hasAccess = await protectPage(TIERS.ADMIN, "admin");
          if (hasAccess) {
            loading.style.display = "none";
            content.style.display = "block";

            // Load all data
            await Promise.all([
              loadUsers(),
              loadFeedback(),
              loadAccessLogs(),
              loadStats(),
            ]);
          }
        } else {
          window.location.href = "../index.html?action=signin";
        }
      });

      // Load all users
      async function loadUsers() {
        try {
          const users = await getAllUsers();
          const userList = document.getElementById("userList");

          if (users.length === 0) {
            userList.innerHTML =
              '<p style="text-align: center; color: #666;">No users found</p>';
            return;
          }

          userList.innerHTML = users
            .map(
              (user) => `
            <div class="user-item">
              <div class="user-info-admin">
                <img 
                  class="user-avatar-small" 
                  src="${
                    user.photoURL ||
                    `https://ui-avatars.com/api/?name=${encodeURIComponent(
                      user.displayName || user.email
                    )}&background=617140&color=fff`
                  }"
                  alt="${user.displayName || "User"}"
                />
                <div class="user-details">
                  <div class="user-email">${escapeHtml(user.email)}</div>
                  <div class="user-meta">
                    Last login: ${
                      user.lastLogin
                        ? new Date(
                            user.lastLogin.seconds * 1000
                          ).toLocaleDateString()
                        : "Never"
                    }
                    | Logins: ${user.loginCount || 0}
                  </div>
                </div>
              </div>
              <select 
                class="tier-selector tier-${user.tier}" 
                onchange="updateUserTier('${user.id}', this.value)"
                ${user.email === "chaceclaborn@gmail.com" ? "disabled" : ""}
              >
                <option value="authenticated" ${
                  user.tier === "authenticated" ? "selected" : ""
                }>Member</option>
                <option value="family" ${
                  user.tier === "family" ? "selected" : ""
                }>Family</option>
                <option value="girlfriend" ${
                  user.tier === "girlfriend" ? "selected" : ""
                }>Special</option>
                <option value="admin" ${
                  user.tier === "admin" ? "selected" : ""
                }>Admin</option>
              </select>
            </div>
          `
            )
            .join("");

          // Update total users count
          document.getElementById("totalUsers").textContent = users.length;

          // Update tier statistics
          const stats = await getTierStats();
          if (stats) {
            const tierStatsDiv = document.getElementById("tierStats");
            tierStatsDiv.innerHTML = Object.entries(stats.byTier)
              .filter(([tier, count]) => count > 0)
              .map(
                ([tier, count]) => `
                <div class="stat-card" style="margin-bottom: 10px;">
                  <div class="stat-label">${
                    tier.charAt(0).toUpperCase() + tier.slice(1)
                  }</div>
                  <div class="stat-value">${count}</div>
                </div>
              `
              )
              .join("");
          }
        } catch (error) {
          console.error("Error loading users:", error);
          document.getElementById("userList").innerHTML =
            '<p style="color: red;">Error loading users</p>';
        }
      }

      // Update user tier
      async function updateUserTier(userId, newTier) {
        if (!confirm(`Change user's tier to ${newTier}?`)) {
          await loadUsers(); // Reload to reset dropdown
          return;
        }

        try {
          const success = await setUserTier(userId, newTier);
          if (success) {
            showNotification("User tier updated successfully!", "success");
            await loadUsers();
          } else {
            showNotification("Failed to update user tier", "error");
            await loadUsers();
          }
        } catch (error) {
          console.error("Error updating tier:", error);
          showNotification("Error updating user tier", "error");
          await loadUsers();
        }
      }

      // Load feedback
      async function loadFeedback() {
        try {
          const feedbackSnapshot = await getDocs(
            query(
              collection(db, "feedback/comments"),
              orderBy("timestamp", "desc")
            )
          );

          const feedbackList = document.getElementById("feedbackList");

          if (feedbackSnapshot.empty) {
            feedbackList.innerHTML =
              '<p style="text-align: center; color: #666;">No feedback yet</p>';
            document.getElementById("totalFeedback").textContent = "0";
            return;
          }

          const feedback = [];
          feedbackSnapshot.forEach((doc) => {
            feedback.push({ id: doc.id, ...doc.data() });
          });

          feedbackList.innerHTML = feedback
            .map((item) => {
              const date = item.timestamp
                ? new Date(item.timestamp.seconds * 1000).toLocaleString()
                : "Unknown";
              return `
              <div class="feedback-item">
                <div class="feedback-header">
                  <span><strong>${escapeHtml(item.email)}</strong> ${
                item.authenticated ? "✓" : ""
              }</span>
                  <span>${date}</span>
                </div>
                <div class="feedback-text">${escapeHtml(item.text)}</div>
                ${
                  item.device
                    ? `<div style="font-size: 0.8rem; color: #999; margin-top: 5px;">Device: ${item.device}</div>`
                    : ""
                }
              </div>
            `;
            })
            .join("");

          document.getElementById("totalFeedback").textContent =
            feedback.length;
        } catch (error) {
          console.error("Error loading feedback:", error);
          document.getElementById("feedbackList").innerHTML =
            '<p style="color: red;">Error loading feedback</p>';
        }
      }

      // Load access logs
      async function loadAccessLogs() {
        try {
          const logsSnapshot = await getDocs(
            query(
              collection(db, "access_logs"),
              orderBy("timestamp", "desc"),
              limit(100)
            )
          );

          const logsList = document.getElementById("accessLogs");

          if (logsSnapshot.empty) {
            logsList.innerHTML =
              '<p style="text-align: center; color: #666;">No access logs</p>';
            return;
          }

          const logs = [];
          logsSnapshot.forEach((doc) => {
            logs.push({ id: doc.id, ...doc.data() });
          });

          logsList.innerHTML = logs
            .map((log) => {
              const date = log.timestamp
                ? new Date(log.timestamp.seconds * 1000).toLocaleString()
                : "Unknown";
              return `
              <div class="log-item">
                <div class="log-status ${
                  log.allowed ? "log-allowed" : "log-denied"
                }" title="${log.allowed ? "Allowed" : "Denied"}"></div>
                <div class="log-details">
                  <strong>${escapeHtml(log.userEmail)}</strong> → <strong>${
                log.page
              }</strong>
                  <br>
                  <span style="font-size: 0.8rem; color: #999;">${date}</span>
                </div>
              </div>
            `;
            })
            .join("");
        } catch (error) {
          console.error("Error loading access logs:", error);
          document.getElementById("accessLogs").innerHTML =
            '<p style="color: red;">Error loading logs</p>';
        }
      }

      // Load statistics
      async function loadStats() {
        try {
          // Load rating stats
          const statsDoc = await getDoc(doc(db, "feedback/stats/aggregate"));
          if (statsDoc.exists()) {
            const stats = statsDoc.data();
            document.getElementById("avgRating").textContent = (
              stats.averageRating || 0
            ).toFixed(1);
            document.getElementById("totalRatings").textContent =
              stats.totalRatings || 0;
          }
        } catch (error) {
          console.error("Error loading stats:", error);
        }
      }

      // Update rating statistics
      async function updateRatingStats() {
        const resultDiv = document.getElementById("statsUpdateResult");
        resultDiv.innerHTML =
          '<div class="loading-spinner" style="width: 20px; height: 20px;"></div>';

        try {
          const ratingsSnapshot = await getDocs(
            collection(db, "feedback/ratings")
          );

          let total = 0;
          let count = 0;
          const distribution = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };

          ratingsSnapshot.forEach((doc) => {
            const rating = doc.data().rating;
            if (rating >= 1 && rating <= 5) {
              total += rating;
              count++;
              distribution[rating]++;
            }
          });

          const average = count > 0 ? total / count : 0;

          await setDoc(doc(db, "feedback/stats/aggregate"), {
            averageRating: average,
            totalRatings: count,
            totalSum: total,
            distribution: distribution,
            lastUpdated: serverTimestamp(),
            updatedBy: auth.currentUser.email,
          });

          resultDiv.innerHTML = `
            <div style="padding: 15px; background: #e8f5e9; border-radius: 8px; color: #2e7d32;">
              <i class="fas fa-check-circle"></i> Stats updated successfully!<br>
              <small>Average: ${average.toFixed(
                2
              )} | Total: ${count} ratings</small>
            </div>
          `;

          // Reload stats
          await loadStats();

          // Clear message after 5 seconds
          setTimeout(() => {
            resultDiv.innerHTML = "";
          }, 5000);
        } catch (error) {
          console.error("Error updating stats:", error);
          resultDiv.innerHTML = `
            <div style="padding: 15px; background: #ffebee; border-radius: 8px; color: #c62828;">
              <i class="fas fa-times-circle"></i> Error updating stats
            </div>
          `;
        }
      }

      // Export feedback to CSV
      async function exportFeedback() {
        try {
          showNotification("Preparing export...", "info");

          // Import feedback service
          const { exportFeedbackToCSV } = await import(
            "../js/firebase/feedback-service.js"
          );
          const csvData = await exportFeedbackToCSV();

          // Create and download files
          const timestamp = new Date().toISOString().split("T")[0];

          // Download ratings CSV
          const ratingsBlob = new Blob([csvData.ratings], { type: "text/csv" });
          const ratingsUrl = URL.createObjectURL(ratingsBlob);
          const ratingsLink = document.createElement("a");
          ratingsLink.href = ratingsUrl;
          ratingsLink.download = `ratings_${timestamp}.csv`;
          ratingsLink.click();

          // Download feedback CSV
          setTimeout(() => {
            const feedbackBlob = new Blob([csvData.feedback], {
              type: "text/csv",
            });
            const feedbackUrl = URL.createObjectURL(feedbackBlob);
            const feedbackLink = document.createElement("a");
            feedbackLink.href = feedbackUrl;
            feedbackLink.download = `feedback_${timestamp}.csv`;
            feedbackLink.click();

            showNotification(
              "Export completed! Check your downloads.",
              "success"
            );
          }, 1000);
        } catch (error) {
          console.error("Error exporting feedback:", error);
          showNotification("Error exporting feedback", "error");
        }
      }

      // Clear old logs
      async function clearOldLogs() {
        if (
          !confirm("This will delete access logs older than 30 days. Continue?")
        )
          return;

        try {
          showNotification("Feature requires Cloud Functions setup", "info");
          // In production, this would call a Cloud Function
        } catch (error) {
          console.error("Error clearing logs:", error);
          showNotification("Error clearing logs", "error");
        }
      }

      // Run security test
      async function runSecurityTest() {
        const resultsDiv = document.getElementById("securityResults");
        resultsDiv.style.display = "block";
        resultsDiv.innerHTML =
          '<div class="loading-spinner" style="width: 30px; height: 30px; margin: 0 auto;"></div>';

        try {
          // Import and run security tests
          const module = await import("../dev/tests/security-test.js");
          const results = await module.runSecurityTests();

          resultsDiv.innerHTML = `
            <h3>Security Test Results</h3>
            <p class="security-pass">✅ Passed: ${results.passed} tests</p>
            <p class="security-fail">❌ Failed: ${results.failed} tests</p>
            ${
              results.critical.length > 0
                ? `<div class="security-fail">
                <strong>⚠️ Critical Issues Found:</strong>
                <ul>${results.critical
                  .map((issue) => `<li>${escapeHtml(issue)}</li>`)
                  .join("")}</ul>
              </div>`
                : '<p class="security-pass"><strong>✅ No critical security issues found!</strong></p>'
            }
            <p style="margin-top: 15px;">
              <small>Full details logged to console. Press F12 to view.</small>
            </p>
          `;
        } catch (error) {
          console.error("Error running security test:", error);
          resultsDiv.innerHTML = `
            <p class="security-fail">❌ Error running security test: ${error.message}</p>
            <p><small>Make sure dev/tests/security-test.js exists</small></p>
          `;
        }
      }

      // Helper function to escape HTML
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Helper function to show notifications
      function showNotification(message, type = "info") {
        const colors = {
          success: "#4CAF50",
          error: "#f44336",
          info: "#2196F3",
        };

        const notification = document.createElement("div");
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 15px 25px;
          background: ${colors[type]};
          color: white;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          z-index: 1000;
          animation: slideIn 0.3s ease;
        `;
        notification.textContent = message;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.style.animation = "slideOut 0.3s ease";
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }

      // Add animation styles
      const style = document.createElement("style");
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
      `;
      document.head.appendChild(style);

      // Auto-refresh data every 5 minutes
      setInterval(() => {
        loadStats();
      }, 300000);
    </script>

    <!-- Firebase Authentication -->
    <script type="module" src="../js/firebase/config.js"></script>
    <script type="module" src="../js/firebase/auth-service.js"></script>
    <script type="module" src="../js/firebase/auth-tiers.js"></script>
    <script type="module" src="../js/auth-init.js"></script>
  </body>
</html>
